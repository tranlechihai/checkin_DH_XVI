<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ƒêi·ªÉm danh ƒê·∫°i h·ªôi XVI</title>
  <link rel="icon" type="image/png" href="./static/images/logo_hcmue.ico">
  <style>
      thead th {
      background-color: #2a4d9b;  /* m√†u xanh d∆∞∆°ng ƒë·∫≠m */
      color: white;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    button {
      padding: 5px 10px;
    }
    .reset-btn {
      background-color: #f8d7da;
      border: 1px solid #dc3545;
      color: black;
    }

    .vang-btn {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: black;
    }

    .comat-btn {
      background-color: #d4edda;
      border: 1px solid #28a745;
      color: black;
    }

    .reset-btn:hover,
    .vang-btn:hover,
    .comat-btn:hover {
      filter: brightness(0.95);
      cursor: pointer;
    }
  </style>
  <script>
    const Diemdanh = []; // M·∫£ng l∆∞u m√£, t√™n v√† chi b·ªô ƒë√£ ƒëi·ªÉm danh
    let allData = [];
    fetch("./static/dai_bieu_updated.json")
      .then(res => res.json())
      .then(data => {
        allData = data; // üëà L∆∞u l·∫°i ƒë·ªÉ d√πng cho t√¨m ki·∫øm
      });
    function showImage(name, filePath) {
      const data = { name, file: filePath, time: Date.now() };
      localStorage.setItem("displayImage", JSON.stringify(data));
    }
    function toggleCheck(person, button, checkCell) {
      const newCheckUp = !person.check_up;

      fetch("http://localhost:5000/api/update_check", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          ma_dai_bieu: person.ma_dai_bieu,
          check_up: newCheckUp
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i tr√™n client
          person.check_up = newCheckUp;
          checkCell.textContent = newCheckUp ? "‚úîÔ∏è" : "‚ùå";
          button.textContent = newCheckUp ? "H·ªßy ƒëi·ªÉm danh" : "ƒêi·ªÉm danh";
          showImage(person.ho_va_ten, person.file_hinh);
        } else {
          alert("L·ªói khi c·∫≠p nh·∫≠t: " + result.error);
        }
      })
      .catch(err => {
        console.error("L·ªói k·∫øt n·ªëi t·ªõi server:", err);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.");
      });
    }
    document.addEventListener("DOMContentLoaded", () => {
      fetch("./static/dai_bieu_updated.json")
        .then(res => res.json())
        .then(data => {
          // console.log("D·ªØ li·ªáu ƒë√£ t·∫£i:", data);
          const tbody = document.querySelector("#danhSach tbody");
          data.forEach(person => {
            //person.check_up = false; // m·∫∑c ƒë·ªãnh ban ƒë·∫ßu l√† ch∆∞a ƒëi·ªÉm danh

            const row = document.createElement("tr");

            const checkCell = document.createElement("td");
            if(person.check_up) checkCell.textContent = "‚úîÔ∏è";
            else checkCell.textContent = "‚ùå";

            const button = document.createElement("button");
            if (person.check_up) button.textContent = "H·ªßy ƒëi·ªÉm danh";
            else button.textContent = "ƒêi·ªÉm danh";
            button.onclick = () => toggleCheck(person, button, checkCell);

            row.innerHTML = `
              <td>${person.ma_dai_bieu}</td>
              <td>${person.ho_va_ten}</td>
              <td>${person.chi_bo}</td>
              <td>${person.gioi}</td>
            `;
            row.appendChild(checkCell);

            const imgCell = document.createElement("td");
            const imgButton = document.createElement("button");
            imgButton.textContent = "Hi·ªÉn th·ªã ·∫£nh";
            imgButton.onclick = () => showImage(person.ho_va_ten, person.file_hinh);
            imgCell.appendChild(imgButton);
            row.appendChild(imgCell);

            const diemDanhCell = document.createElement("td");
            diemDanhCell.appendChild(button);
            row.appendChild(diemDanhCell);

            tbody.appendChild(row);
          });
        })
        .catch(err => console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err));
    });
    function searchPerson() {
      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultDiv = document.getElementById("search_daibieu");
      resultDiv.innerHTML = ""; // X√≥a k·∫øt qu·∫£ c≈©

      if (!query) {
        resultDiv.innerHTML = "<p>Vui l√≤ng nh·∫≠p t√™n ho·∫∑c m√£ ƒë·∫°i bi·ªÉu.</p>";
        return;
      }

      const matches = allData.filter(p =>
        p.ma_dai_bieu.toLowerCase().includes(query) ||
        p.ho_va_ten.toLowerCase().includes(query)
      );

      if (matches.length === 0) {
        resultDiv.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y ƒë·∫°i bi·ªÉu.</p>";
        return;
      }

      // Hi·ªÉn th·ªã k·∫øt qu·∫£
      matches.forEach(p => {
        const buttonLabel = p.check_up ? "H·ªßy ƒëi·ªÉm danh" : "ƒêi·ªÉm danh";
        const buttonHtml = `<button onclick="toggleCheckBySearch('${p.ma_dai_bieu}')">${buttonLabel}</button>`;

        const bgColor = p.check_up ? "#e6ffe6" : "#fff";  // xanh nh·∫°t n·∫øu ƒë√£ ƒëi·ªÉm danh

        const html = `
          <div style="
            background: ${bgColor};
            max-width: 700px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 15px;
          ">
            <div style="display: flex; flex-wrap: wrap; gap: 16px;">
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>M√£ ƒë·∫°i bi·ªÉu:</strong> ${p.ma_dai_bieu}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>H·ªç v√† t√™n:</strong> ${p.ho_va_ten}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Chi b·ªô:</strong> ${p.chi_bo}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Gi·ªõi:</strong> ${p.gioi}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Ng√†y sinh:</strong> ${p.ngay_sinh}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Ng√†y d·ª± b·ªã:</strong> ${p.ngay_du_bi}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Ch·ª©c v·ª• ƒë·∫£ng:</strong> ${p.Chuc_vu_dang}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Ch·ª©c v·ª• ch√≠nh quy·ªÅn:</strong> ${p.Chuc_vu_chinh_quyen}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Tr√¨nh ƒë·ªô chuy√™n m√¥n:</strong> ${p.trinh_do_chuyen_mon}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Tr√¨nh ƒë·ªô l√Ω lu·∫≠n ch√≠nh tr·ªã:</strong> ${p.trinh_do_ly_luan_chinh_tri}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Check-up:</strong> ${p.check_up ? "‚úîÔ∏è" : "‚ùå"}</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
              ${buttonHtml}
            </div>
          </div>
        `;


        resultDiv.innerHTML += html;
      });
    }
  function toggleCheckBySearch(ma_dai_bieu) {
  const person = allData.find(p => p.ma_dai_bieu === ma_dai_bieu);
  if (!person) {
    alert("Kh√¥ng t√¨m th·∫•y ƒë·∫°i bi·ªÉu.");
    return;
  }

  const newCheck = !person.check_up;

  fetch("http://localhost:5000/api/update_check", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      ma_dai_bieu: person.ma_dai_bieu,
      check_up: newCheck
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      // ‚úÖ C·∫≠p nh·∫≠t tr·∫°ng th√°i trong allData
      person.check_up = newCheck;

      // ‚úÖ C·∫≠p nh·∫≠t l·∫°i ph·∫ßn t√¨m ki·∫øm
      searchPerson();

      // ‚úÖ C·∫≠p nh·∫≠t l·∫°i d√≤ng t∆∞∆°ng ·ª©ng trong b·∫£ng (n·∫øu c√≥)
      const rows = document.querySelectorAll("#danhSach tbody tr");
      rows.forEach(row => {
        const cellMa = row.cells[0]?.textContent.trim();
        if (cellMa === ma_dai_bieu) {
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i check
          row.cells[4].textContent = newCheck ? "‚úîÔ∏è" : "‚ùå";

          // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÉm danh (n√∫t th·ª© 2, sau "Hi·ªÉn th·ªã ·∫£nh")
          const buttons = row.querySelectorAll("button");
          if (buttons.length >= 2) {
            buttons[1].textContent = newCheck ? "H·ªßy ƒëi·ªÉm danh" : "ƒêi·ªÉm danh";
          }
        }
      });


      showImage(person.ho_va_ten, person.file_hinh);

    } else {
      alert("L·ªói khi c·∫≠p nh·∫≠t: " + result.error);
    }
  })
  .catch(err => {
    console.error("L·ªói khi g·ª≠i y√™u c·∫ßu:", err);
    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.");
  });
}

    function resetDiemDanh() {
  const confirmReset = confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset t·∫•t c·∫£ ƒëi·ªÉm danh v·ªÅ m·∫∑c ƒë·ªãnh ‚ùå?");
  if (!confirmReset) return;

  fetch("http://localhost:5000/api/reset_check", {
    method: "POST"
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      alert("ƒê√£ reset ƒëi·ªÉm danh.");
      location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t
    } else {
      alert("L·ªói khi reset: " + result.error);
    }
  })
  .catch(err => {
    console.error("L·ªói k·∫øt n·ªëi:", err);
    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.");
  });
}
    function exportVang() {
  fetch("http://localhost:5000/api/export_vang", {
    method: "GET"
  })
  .then(res => res.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DHXVI_danh_sach_vang_mat.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
  })
  .catch(err => {
    console.error("L·ªói khi t·∫£i file:", err);
    alert("Kh√¥ng th·ªÉ t·∫°o ho·∫∑c t·∫£i file.");
  });
}
    function exportComat() {
  fetch("http://localhost:5000/api/export_comat", {
    method: "GET"
  })
  .then(res => res.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DHXVI_danh_sach_co_mat.xlsx.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
  })
  .catch(err => {
    console.error("L·ªói khi t·∫£i file:", err);
    alert("Kh√¥ng th·ªÉ t·∫°o ho·∫∑c t·∫£i file.");
  });
}

function handleSearch(event) {
  event.preventDefault();  // ch·∫∑n reload trang
  searchPerson();
}

  </script>
</head>
<body style="font-family: Arial, sans-serif;">
  <div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
    <div style="font-size: 28px; font-weight: bold; color: #0d4d91; margin-bottom: 10px;">
      ƒêI·ªÇM DANH PHI√äN 1
    </div>
    <div style="font-size: 20px; font-weight: bold; color: #0d4d91; line-height: 1.5;">
      ƒê·∫†I H·ªòI ƒê·∫†I BI·ªÇU ƒê·∫¢NG B·ªò TR∆Ø·ªúNG ƒê·∫†I H·ªåC S∆Ø PH·∫†M TH√ÄNH PH·ªê H·ªí CH√ç MINH<br>
      L·∫¶N TH·ª® XVI - NHI·ªÜM K√å 2025 - 2027
    </div>
  </div>

  <div style="max-width: 1200px; margin: auto; padding: 20px;">
    <!-- Khung t√¨m ki·∫øm -->
    <form id="searchForm" onsubmit="handleSearch(event)" style="display: flex; gap: 10px; margin-bottom: 15px;">
      <input type="text" id="searchInput" placeholder="Nh·∫≠p m√£ ƒë·∫°i bi·ªÉu ho·∫∑c h·ªç t√™n" style="flex: 1; padding: 8px;">
      <button type="submit" style="background-color: #0d4d91; color: white; border: none; padding: 8px 16px;">T√¨m ki·∫øm</button>
    </form>



    <!-- K·∫øt qu·∫£ t√¨m ki·∫øm -->
    <div id="search_daibieu" style="margin-bottom: 30px;"></div>

    <!-- B·∫£ng danh s√°ch -->
    <table id="danhSach">
      <thead>
        <tr>
          <th>M√£ ƒë·∫°i bi·ªÉu</th>
          <th>H·ªç v√† t√™n</th>
          <th>Chi b·ªô</th>
          <th>Gi·ªõi</th>
          <th>Check In</th>
          <th>Hi·ªÉn th·ªã ·∫£nh</th> 
          <th>ƒêi·ªÉm danh</th>
        </tr>
      </thead>
      <tbody>
        <!-- JavaScript s·∫Ω ch√®n d·ªØ li·ªáu t·∫°i ƒë√¢y -->
      </tbody>
    </table>
        <!-- Nh√≥m c√°c n√∫t ch·ª©c nƒÉng -->
    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
      <button onclick="resetDiemDanh()" class="reset-btn">Reset ƒêi·ªÉm danh</button>
      <button onclick="exportVang()" class="vang-btn">Xu·∫•t file ƒë·∫°i bi·ªÉu v·∫Øng</button>
      <button onclick="exportComat()" class="comat-btn">Xu·∫•t file ƒë·∫°i bi·ªÉu c√≥ m·∫∑t</button>
    </div>
  </div>
</body>
</html>
