<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Äiá»ƒm danh Äáº¡i há»™i XVI</title>
  <link rel="icon" type="image/png" href="./static/images/logo_hcmue.ico">
  <style>
      thead th {
      background-color: #2a4d9b;  /* mÃ u xanh dÆ°Æ¡ng Ä‘áº­m */
      color: white;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    button {
      padding: 5px 10px;
    }
    .reset-btn {
      background-color: #f8d7da;
      border: 1px solid #dc3545;
      color: black;
    }

    .vang-btn {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: black;
    }

    .comat-btn {
      background-color: #d4edda;
      border: 1px solid #28a745;
      color: black;
    }

    .reset-btn:hover,
    .vang-btn:hover,
    .comat-btn:hover {
      filter: brightness(0.95);
      cursor: pointer;
    }
  </style>
  <script>
    const Diemdanh = []; // Máº£ng lÆ°u mÃ£, tÃªn vÃ  chi bá»™ Ä‘Ã£ Ä‘iá»ƒm danh
    let allData = [];
    fetch("./static/dai_bieu_updated.json")
      .then(res => res.json())
      .then(data => {
        allData = data; // ğŸ‘ˆ LÆ°u láº¡i Ä‘á»ƒ dÃ¹ng cho tÃ¬m kiáº¿m
      });
    function showImage(name, filePath) {
      const data = { name, file: filePath, time: Date.now() };
      localStorage.setItem("displayImage", JSON.stringify(data));
    }
    function toggleCheck(person, button, checkCell) {
      const newCheckUp = !person.check_up;

      fetch("https://haitlc.pythonanywhere.com/api/update_check", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          ma_dai_bieu: person.ma_dai_bieu,
          check_up: newCheckUp
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          // Cáº­p nháº­t tráº¡ng thÃ¡i trÃªn client
          person.check_up = newCheckUp;
          checkCell.textContent = newCheckUp ? "âœ”ï¸" : "âŒ";
          button.textContent = newCheckUp ? "Há»§y Ä‘iá»ƒm danh" : "Äiá»ƒm danh";
          showImage(person.ho_va_ten, person.file_hinh);
        } else {
          alert("Lá»—i khi cáº­p nháº­t: " + result.error);
        }
      })
      .catch(err => {
        console.error("Lá»—i káº¿t ná»‘i tá»›i server:", err);
        alert("KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i server.");
      });
    }
    document.addEventListener("DOMContentLoaded", () => {
      fetch("./static/dai_bieu_updated.json")
        .then(res => res.json())
        .then(data => {
          // console.log("Dá»¯ liá»‡u Ä‘Ã£ táº£i:", data);
          const tbody = document.querySelector("#danhSach tbody");
          data.forEach(person => {
            //person.check_up = false; // máº·c Ä‘á»‹nh ban Ä‘áº§u lÃ  chÆ°a Ä‘iá»ƒm danh

            const row = document.createElement("tr");

            const checkCell = document.createElement("td");
            if(person.check_up) checkCell.textContent = "âœ”ï¸";
            else checkCell.textContent = "âŒ";

            const button = document.createElement("button");
            if (person.check_up) button.textContent = "Há»§y Ä‘iá»ƒm danh";
            else button.textContent = "Äiá»ƒm danh";
            button.onclick = () => toggleCheck(person, button, checkCell);

            row.innerHTML = `
              <td>${person.ma_dai_bieu}</td>
              <td>${person.ho_va_ten}</td>
              <td>${person.chi_bo}</td>
              <td>${person.gioi}</td>
            `;
            row.appendChild(checkCell);

            const imgCell = document.createElement("td");
            const imgButton = document.createElement("button");
            imgButton.textContent = "Hiá»ƒn thá»‹ áº£nh";
            imgButton.onclick = () => showImage(person.ho_va_ten, person.file_hinh);
            imgCell.appendChild(imgButton);
            row.appendChild(imgCell);

            const diemDanhCell = document.createElement("td");
            diemDanhCell.appendChild(button);
            row.appendChild(diemDanhCell);

            tbody.appendChild(row);
          });
        })
        .catch(err => console.error("Lá»—i táº£i dá»¯ liá»‡u:", err));
    });
    function searchPerson() {
      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultDiv = document.getElementById("search_daibieu");
      resultDiv.innerHTML = "";

      // âœ… Äá»“ng bá»™ tráº¡ng thÃ¡i check tá»« báº£ng
      document.querySelectorAll("#danhSach tbody tr").forEach(row => {
        const ma = row.cells[0].textContent.trim();
        const isChecked = row.cells[4].textContent.trim() === "âœ”ï¸";
        const index = allData.findIndex(p => p.ma_dai_bieu === ma);
        if (index !== -1) allData[index].check_up = isChecked;
      });

      if (!query) {
        resultDiv.innerHTML = "<p>Vui lÃ²ng nháº­p tÃªn hoáº·c mÃ£ Ä‘áº¡i biá»ƒu.</p>";
        return;
      }

      const matches = allData.filter(p =>
        p.ma_dai_bieu.toLowerCase().includes(query) ||
        p.ho_va_ten.toLowerCase().includes(query)
      );

      if (matches.length === 0) {
        resultDiv.innerHTML = "<p>KhÃ´ng tÃ¬m tháº¥y Ä‘áº¡i biá»ƒu.</p>";
        return;
      }

      // Hiá»ƒn thá»‹ káº¿t quáº£
      matches.forEach(p => {
        const buttonLabel = p.check_up ? "Há»§y Ä‘iá»ƒm danh" : "Äiá»ƒm danh";
        const buttonHtml = `<button onclick="toggleCheckBySearch('${p.ma_dai_bieu}')">${buttonLabel}</button>`;

        const bgColor = p.check_up ? "#e6ffe6" : "#fff";  // xanh nháº¡t náº¿u Ä‘Ã£ Ä‘iá»ƒm danh

        const html = `
          <div style="
            background: ${bgColor};
            max-width: 700px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 15px;
          ">
            <div style="display: flex; flex-wrap: wrap; gap: 16px;">
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>MÃ£ Ä‘áº¡i biá»ƒu:</strong> ${p.ma_dai_bieu}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Há» vÃ  tÃªn:</strong> ${p.ho_va_ten}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Chi bá»™:</strong> ${p.chi_bo}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Giá»›i:</strong> ${p.gioi}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>NgÃ y sinh:</strong> ${p.ngay_sinh}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>NgÃ y dá»± bá»‹:</strong> ${p.ngay_du_bi}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Chá»©c vá»¥ Ä‘áº£ng:</strong> ${p.Chuc_vu_dang}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Chá»©c vá»¥ chÃ­nh quyá»n:</strong> ${p.Chuc_vu_chinh_quyen}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>TrÃ¬nh Ä‘á»™ chuyÃªn mÃ´n:</strong> ${p.trinh_do_chuyen_mon}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>TrÃ¬nh Ä‘á»™ lÃ½ luáº­n chÃ­nh trá»‹:</strong> ${p.trinh_do_ly_luan_chinh_tri}</p>
              <p style="flex: 1 1 45%; margin: 3px 0;"><strong>Check-up:</strong> ${allData.find(a => a.ma_dai_bieu === p.ma_dai_bieu)?.check_up ? "âœ”ï¸" : "âŒ"}</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
              ${buttonHtml}
            </div>
          </div>
        `;


        resultDiv.innerHTML += html;
      });
    }
  function toggleCheckBySearch(ma_dai_bieu) {
  const person = allData.find(p => p.ma_dai_bieu === ma_dai_bieu);
  if (!person) {
    alert("KhÃ´ng tÃ¬m tháº¥y Ä‘áº¡i biá»ƒu.");
    return;
  }

  const newCheck = !person.check_up;

  fetch("https://haitlc.pythonanywhere.com/api/update_check", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      ma_dai_bieu: person.ma_dai_bieu,
      check_up: newCheck
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      // âœ… Cáº­p nháº­t tráº¡ng thÃ¡i trong allData
      const index = allData.findIndex(p => p.ma_dai_bieu === ma_dai_bieu);
      if (index !== -1) {
        allData[index].check_up = newCheck;
      }

      // âœ… Cáº­p nháº­t láº¡i pháº§n tÃ¬m kiáº¿m
      searchPerson();

      // âœ… Cáº­p nháº­t láº¡i dÃ²ng tÆ°Æ¡ng á»©ng trong báº£ng (náº¿u cÃ³)
      const rows = document.querySelectorAll("#danhSach tbody tr");
      rows.forEach(row => {
        const cellMa = row.cells[0]?.textContent.trim();
        if (cellMa === ma_dai_bieu) {
          // Cáº­p nháº­t tráº¡ng thÃ¡i check
          row.cells[4].textContent = newCheck ? "âœ”ï¸" : "âŒ";

          // Cáº­p nháº­t nÃºt Ä‘iá»ƒm danh (nÃºt thá»© 2, sau "Hiá»ƒn thá»‹ áº£nh")
          const buttons = row.querySelectorAll("button");
          if (buttons.length >= 2) {
            buttons[1].textContent = newCheck ? "Há»§y Ä‘iá»ƒm danh" : "Äiá»ƒm danh";
          }
        }
      });

      showImage(person.ho_va_ten, person.file_hinh);
    } else {
      alert("Lá»—i khi cáº­p nháº­t: " + result.error);
    }
  })
  .catch(err => {
    console.error("Lá»—i khi gá»­i yÃªu cáº§u:", err);
    alert("KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i server.");
  });
}

  function resetDiemDanh() {
  const password = prompt("Vui lÃ²ng nháº­p máº­t kháº©u Ä‘á»ƒ xÃ¡c nháº­n reset Ä‘iá»ƒm danh:");
  if (!password) {
    alert("ÄÃ£ há»§y thao tÃ¡c.");
    return;
  }

  const correctPassword = "hcmue@123";  

  if (password !== correctPassword) {
    alert("Sai máº­t kháº©u. KhÃ´ng thá»±c hiá»‡n reset.");
    return;
  }

  const confirmReset = confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n reset táº¥t cáº£ Ä‘iá»ƒm danh vá» âŒ?");
  if (!confirmReset) return;

  fetch("https://haitlc.pythonanywhere.com/api/reset_check", {
    method: "POST"
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert("ÄÃ£ reset Ä‘iá»ƒm danh.");
        location.reload();
      } else {
        alert("Lá»—i khi reset: " + result.error);
      }
    })
    .catch(err => {
      console.error("Lá»—i káº¿t ná»‘i:", err);
      alert("KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i server.");
    });
}

    function exportVang() {
  fetch("https://haitlc.pythonanywhere.com/api/export_vang", {
    method: "GET"
  })
  .then(res => res.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DHXVI_danh_sach_vang_mat.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
  })
  .catch(err => {
    console.error("Lá»—i khi táº£i file:", err);
    alert("KhÃ´ng thá»ƒ táº¡o hoáº·c táº£i file.");
  });
}
    function exportComat() {
  fetch("https://haitlc.pythonanywhere.com/api/export_comat", {
    method: "GET"
  })
  .then(res => res.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DHXVI_danh_sach_co_mat.xlsx.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
  })
  .catch(err => {
    console.error("Lá»—i khi táº£i file:", err);
    alert("KhÃ´ng thá»ƒ táº¡o hoáº·c táº£i file.");
  });
}

function handleSearch(event) {
  event.preventDefault();  // cháº·n reload trang
  searchPerson();
}

  function updateFromServer() {
    fetch("./static/dai_bieu_updated.json")
      .then(res => res.json())
      .then(data => {
        allData = data;
      });
  }

  setInterval(updateFromServer, 3000);

  </script>
</head>
<body style="font-family: Arial, sans-serif;">
  <div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
    <div style="font-size: 28px; font-weight: bold; color: #0d4d91; margin-bottom: 10px;">
      ÄIá»‚M DANH PHIÃŠN 1
    </div>
    <div style="font-size: 20px; font-weight: bold; color: #0d4d91; line-height: 1.5;">
      Äáº I Há»˜I Äáº I BIá»‚U Äáº¢NG Bá»˜ TRÆ¯á»œNG Äáº I Há»ŒC SÆ¯ PHáº M THÃ€NH PHá» Há»’ CHÃ MINH<br>
      Láº¦N THá»¨ XVI - NHIá»†M KÃŒ 2025 - 2027
    </div>
  </div>

  <div style="max-width: 1200px; margin: auto; padding: 20px;">
    <!-- Khung tÃ¬m kiáº¿m -->
    <form id="searchForm" onsubmit="handleSearch(event)" style="display: flex; gap: 10px; margin-bottom: 15px;">
      <input type="text" id="searchInput" placeholder="Nháº­p mÃ£ Ä‘áº¡i biá»ƒu hoáº·c há» tÃªn" style="flex: 1; padding: 8px;">
      <button type="submit" style="background-color: #0d4d91; color: white; border: none; padding: 8px 16px;">TÃ¬m kiáº¿m</button>
    </form>



    <!-- Káº¿t quáº£ tÃ¬m kiáº¿m -->
    <div id="search_daibieu" style="margin-bottom: 30px;"></div>

    <!-- Báº£ng danh sÃ¡ch -->
    <table id="danhSach">
      <thead>
        <tr>
          <th>MÃ£ Ä‘áº¡i biá»ƒu</th>
          <th>Há» vÃ  tÃªn</th>
          <th>Chi bá»™</th>
          <th>Giá»›i</th>
          <th>Check In</th>
          <th>Hiá»ƒn thá»‹ áº£nh</th> 
          <th>Äiá»ƒm danh</th>
        </tr>
      </thead>
      <tbody>
        <!-- JavaScript sáº½ chÃ¨n dá»¯ liá»‡u táº¡i Ä‘Ã¢y -->
      </tbody>
    </table>
        <!-- NhÃ³m cÃ¡c nÃºt chá»©c nÄƒng -->
    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
      <button onclick="resetDiemDanh()" class="reset-btn">Reset Äiá»ƒm danh</button>
      <button onclick="exportVang()" class="vang-btn">Xuáº¥t file Ä‘áº¡i biá»ƒu váº¯ng</button>
      <button onclick="exportComat()" class="comat-btn">Xuáº¥t file Ä‘áº¡i biá»ƒu cÃ³ máº·t</button>
    </div>
  </div>
</body>
</html>
